<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Productos - Tienda Virtual</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Oswald:wght@500&family=Roboto&family=Russo+One&family=Teko:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #EDEDED;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #2C3E20;
      color: white;
      display: flex;
      align-items: center;
      padding: 1rem 2rem;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
    }

    .logo img {
      height: 50px;
      margin-right: 1rem;
    }

    .logo-text h1 {
      margin: 0;
      font-size: 1.5rem;
      font-family: 'Russo One', sans-serif;
    }

    .logo-text p {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.8;
      font-family: 'Montserrat', sans-serif;
    }

    nav {
      background-color: #1C1C1C;
      display: flex;
      justify-content: center;
      padding: 0.5rem;
    }

    nav a {
      color: white;
      text-decoration: none;
      margin: 0 1rem;
      font-weight: 500;
      font-family: 'Montserrat', sans-serif;
    }

    .main {
      display: flex;
    }

    .sidebar {
      width: 220px;
      background-color: #2C3E20;
      padding: 1rem;
      color: white;
      min-height: 100vh;
      font-family: 'Roboto', sans-serif;
      position: relative;
    }

    .sidebar h3 {
      margin-top: 0;
      font-size: 1.1rem;
    }

    .sidebar button {
      font-family: 'Montserrat', sans-serif;
    }

    .contenedor-productos {
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
      flex-grow: 1;
    }

    .producto-card {
      width: 220px;
      border: 1px solid #B0B0B0;
      border-radius: 10px;
      padding: 15px;
      background-color: #FAFAFA;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .producto-card img {
      max-width: 100%;
      max-height: 150px;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .producto-card:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 12px rgba(0,0,0,0.12);
    }

    .producto-card h4 {
      font-family: 'Teko', sans-serif;
      font-size: 1.3rem;
      margin-bottom: 8px;
    }

    .producto-card p {
      font-family: 'Roboto', sans-serif;
    }

    .producto-card button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
      background-color: #2C3E20;
      color: white;
      border: none;
      border-radius: 5px;
      transition: background-color 0.3s ease;
      font-family: 'Montserrat', sans-serif;
    }

    .producto-card button:hover {
      background-color: #151515;
    }

    input, form button {
      font-family: 'Montserrat', sans-serif;
    }

    .chatbot {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      background-color: #1C1C1C;
      padding: 10px;
      border-radius: 10px;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.85rem;
    }

    .chatbot h4 {
      margin: 0 0 5px 0;
      font-size: 1rem;
      color: #fff;
      text-align: center;
    }

    .chat-historial {
      height: 100px;
      overflow-y: auto;
      background: #FAFAFA;
      color: #000;
      padding: 5px;
      border-radius: 5px;
      margin-bottom: 5px;
      font-size: 0.75rem;
    }

    .chatbot input {
      width: calc(100% - 60px);
      padding: 5px;
      border-radius: 5px;
      border: none;
      font-size: 0.8rem;
    }

    .chatbot button {
      width: 50px;
      padding: 5px;
      background-color: #2C3E20;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 0.8rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="uploads/LogoPequeño.jpg" alt="Logo Empresa">
      <div class="logo-text">
        <h1>CREACIONES COPI S.A.C.</h1>
        <p>Ropa táctica y textil para las Fuerzas Armadas</p>
      </div>
    </div>
  </header>

  <nav>
    <a href="productos.html">Productos</a>
    <a href="carrito.html">Carrito</a>
    <a href="https://www.facebook.com/perezcopi/?locale=es_LA" target="_blank" rel="noopener noreferrer">Contacto</a>
  </nav>

  <div class="main">
    <aside class="sidebar">
      <h3>Menú</h3>
      <p id="bienvenida"></p>
      <button id="iniciarSesion" style="display: none;">Iniciar Sesión</button>
      <button id="registrarse" style="display: none;">Registrarse</button>
      <button id="verCarrito" style="display: none;">Carrito</button>
      <h3></h3><h3></h3><h3></h3>
      <button id="cerrarSesion" style="display: none;">Cerrar sesión</button>
      <div class="chatbot">
        <h4>Chatbot</h4>
        <div id="chatHistorial" class="chat-historial"></div>
        <input type="text" id="chatInput" placeholder="Escribe aquí..." />
        <button id="enviarChat">Enviar</button>
      </div>
    </aside>

    <section class="contenedor-productos">
      <h2>Vea nuestros productos</h2>
      <div id="productos" class="contenedor-productos"></div>

      <div id="adminPanel" style="display: none;">
        <h3>Agregar producto</h3>
        <form id="formAgregar" enctype="multipart/form-data">
          <input type="text" id="nombre" placeholder="Nombre" required />
          <input type="number" id="precio" placeholder="Precio" required />
          <input type="text" id="descripcion" placeholder="Descripción" required />
          <input type="number" id="stock" placeholder="Stock" required />
          <input type="file" id="imagen" accept="image/png" required />
          <button type="submit">Agregar</button>
        </form>
      </div>

      <div id="formEditarContainer" style="display:none; border:1px solid #333; padding:10px; margin-top:20px;">
        <h3>Editar producto</h3>
        <form id="formEditar" enctype="multipart/form-data">
          <input type="hidden" id="editarId" />
          <input type="text" id="editarNombre" placeholder="Nombre" required />
          <input type="number" id="editarPrecio" placeholder="Precio" required />
          <input type="text" id="editarDescripcion" placeholder="Descripción" required />
          <input type="file" id="editarImagen" accept="image/png" />
          <button type="submit">Guardar cambios</button>
          <button type="button" onclick="cancelarEdicion()">Cancelar</button>
        </form>
      </div>
    </section>
  </div>

  <script>
    const usuario = JSON.parse(localStorage.getItem('usuario'));
    const bienvenida = document.getElementById('bienvenida');
    const adminPanel = document.getElementById('adminPanel');
    const productosDiv = document.getElementById('productos');
    const btnCerrar = document.getElementById('cerrarSesion');
    const btnCarrito = document.getElementById('verCarrito');
    const btnLogin = document.getElementById('iniciarSesion');
    const btnRegistro = document.getElementById('registrarse');


    if (usuario) {
      bienvenida.textContent = `Bienvenido, ${usuario.nombre} (${usuario.rol})`;
      btnCerrar.style.display = 'inline';
      btnCarrito.style.display = 'inline';

      if (usuario.rol === 'Administrador') {
        adminPanel.style.display = 'block';
      }
    } else {
      bienvenida.textContent = 'Bienvenido, usuario nuevo :D';
      btnLogin.style.display = 'inline';
      btnRegistro.style.display = 'inline';
      btnLogin.addEventListener('click', () => {
        window.location.href = 'login.html';
      });
      btnRegistro.addEventListener('click', () => {
        window.location.href = 'registro.html';
      });
    }

    btnCerrar.addEventListener('click', () => {
      localStorage.removeItem('usuario');
      window.location.reload();
    });

    let productos = [];

    async function cargarProductos() {
      const res = await fetch('http://18.229.155.129:3000/productos');
      productos = await res.json();

      productosDiv.innerHTML = productos.map(p => `
        <div class="producto-card">
          <h4>${p.NombreProd}</h4>
          <img src="http://18.229.155.129:3000/uploads/${p.Imagen}" alt="${p.NombreProd}" />
          <p>Precio: S/. ${p.PrecioUnitario}</p>
          <p>Stock disponible: ${p.Stock}</p>
          <p>${p.Descripcion || 'Sin descripción'}</p>
          ${
            usuario?.rol === 'Administrador' ? `
              <button onclick="editarProducto(${p.ID_Producto})">Editar</button>
              <button onclick="eliminarProducto(${p.ID_Producto})">Eliminar</button>
            ` : `
              <input type="number" id="cantidad_${p.ID_Producto}" value="1" min="1" max="${p.Stock}" style="width: 50px;" />
              <button onclick="comprar(${p.ID_Producto})">Comprar</button>
            `
          }
        </div>
      `).join('');
    }
    cargarProductos();

    document.getElementById('formAgregar')?.addEventListener('submit', async e => {
      e.preventDefault();

      const formData = new FormData();
      formData.append('NombreProd', document.getElementById('nombre').value);
      formData.append('PrecioUnitario', document.getElementById('precio').value);
      formData.append('Descripcion', document.getElementById('descripcion').value);
      formData.append('Stock', document.getElementById('stock').value);
      formData.append('imagen', document.getElementById('imagen').files[0]);

      const res = await fetch('http://18.229.155.129:3000/productos', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();
      alert(data.mensaje || 'Producto agregado');
      cargarProductos();
      e.target.reset();
    });

    function eliminarProducto(id) {
      if (!confirm('¿Eliminar este producto?')) return;
      fetch(`http://18.229.155.129:3000/productos/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(() => cargarProductos());
    }

    function editarProducto(id) {
      const producto = productos.find(p => p.ID_Producto === id);
      if (!producto) {
        alert('Producto no encontrado');
        return;
      }

      document.getElementById('editarId').value = producto.ID_Producto;
      document.getElementById('editarNombre').value = producto.NombreProd;
      document.getElementById('editarPrecio').value = producto.PrecioUnitario;
      document.getElementById('editarDescripcion').value = producto.Descripcion || '';
      document.getElementById('formEditarContainer').style.display = 'block';
    }

    function cancelarEdicion() {
      document.getElementById('formEditar').reset();
      document.getElementById('formEditarContainer').style.display = 'none';
    }

    document.getElementById('formEditar')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('editarId').value;

      const formData = new FormData();
      formData.append('NombreProd', document.getElementById('editarNombre').value);
      formData.append('PrecioUnitario', document.getElementById('editarPrecio').value);
      formData.append('Descripcion', document.getElementById('editarDescripcion').value);

      const imagen = document.getElementById('editarImagen').files[0];
      if (imagen) {
        formData.append('imagen', imagen);
      }

      const res = await fetch(`http://18.229.155.129:3000/productos/${id}`, {
        method: 'PUT',
        body: formData
      });

      const data = await res.json();
      alert(data.mensaje || 'Producto actualizado');
      cancelarEdicion();
      cargarProductos();
    });

    function comprar(id) {
      const usuario = JSON.parse(localStorage.getItem('usuario'));
      if (!usuario) {
        alert('Debes iniciar sesión para comprar');
        window.location.href = 'login.html';
        return;
      }

      if (usuario.rol !== 'Cliente') {
        alert('Solo los clientes pueden comprar');
        return;
      }

      const producto = productos.find(p => p.ID_Producto === id);
      if (!producto) {
        alert('Producto no encontrado');
        return;
      }

      const cantidadInput = document.getElementById(`cantidad_${id}`);
      const cantidad = parseInt(cantidadInput?.value || "1");

      if (isNaN(cantidad) || cantidad < 1) {
        alert('Cantidad inválida');
        return;
      }

      let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
      const existente = carrito.find(p => p.ID_Producto === id);
      const cantidadEnCarrito = existente ? existente.cantidad : 0;

      if (cantidadEnCarrito + cantidad > producto.Stock) {
        alert(`No puedes añadir más de ${producto.Stock} unidades. Ya tienes ${cantidadEnCarrito} en el carrito.`);
        return;
      }

      if (existente) {
        existente.cantidad += cantidad;
      } else {
        carrito.push({ ...producto, cantidad });
      }

      localStorage.setItem('carrito', JSON.stringify(carrito));
      alert(`Se añadieron ${cantidad} unidad(es) al carrito`);
    }

    btnCarrito.addEventListener('click', () => {
      window.location.href = 'carrito.html';
    });

    const chatInput = document.getElementById('chatInput');
    const chatHistorial = document.getElementById('chatHistorial');
    const enviarChat = document.getElementById('enviarChat');

    enviarChat.addEventListener('click', async () => {
      const texto = chatInput.value.trim();
      if (!texto) return;

      const entrada = document.createElement('div');
      entrada.textContent = `Tú: ${texto}`;
      chatHistorial.appendChild(entrada);

      chatInput.value = '';
      chatHistorial.scrollTop = chatHistorial.scrollHeight;

      try {
        const res = await fetch('http://18.229.155.129:3000/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mensaje: texto })
        });

        const data = await res.json();
        const respuesta = document.createElement('div');
        respuesta.textContent = `Bot: ${data.respuesta || 'No entendí eso.'}`;
        chatHistorial.appendChild(respuesta);
        chatHistorial.scrollTop = chatHistorial.scrollHeight;
      } catch (error) {
        const errorMsg = document.createElement('div');
        errorMsg.textContent = `Bot: Error al conectar con IA.`;
        chatHistorial.appendChild(errorMsg);
      }
    });
  </script>
</body>
</html>